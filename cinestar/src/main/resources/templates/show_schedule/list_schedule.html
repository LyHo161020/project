<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description">
    <meta content="Coderthemes" name="author">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <th:block th:replace="/layout/head :: head"/>
    <script src="/assets/js/app/jquery-3.6.0.min.js"></script>
</head>
<body>
<div id="wrapper">
    <th:block th:replace="/layout/navbar :: navbar"/>
<<<<<<< HEAD
    <th:block th:replace="/layout/left_sidebar_staff :: left_side_staff"/>
=======

    <!-- ========== Left Sidebar Start ========== -->
    <div th:if="${user.role.getId() == 3}">
        <th:block  th:replace="/layout/left_sidebar_admin :: left_side_admin"/>
    </div>
    <div th:if="${user.role.getId() == 2}">
        <th:block  th:replace="/layout/left_sidebar_staff :: left_side_staff"/>
    </div>
    <!-- Left Sidebar End -->
>>>>>>> origin/qanh_dev

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Minton</a></li>
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Apps</a></li>
                                    <li class="breadcrumb-item active">Tickets</li>
                                </ol>
                            </div>
                            <h4 class="page-title">Tickets</h4>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-12">
                        <div class="card-box">

                            <div class="text-center mb-2">
                                <div class="row">
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-tag font-24"></i>
                                            <h3>25563</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Total tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-archive font-24"></i>
                                            <h3 class="text-warning">6952</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Pending
                                                Tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-shield font-24"></i>
                                            <h3 class="text-success">18361</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Closed Tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-delete font-24"></i>
                                            <h3 class="text-danger">250</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Deleted
                                                Tickets</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-1">
                                <h6>
                                    <i class="icon-copy fa fa-glass" aria-hidden="true"></i>
                                    <strong style="font-size: 23px;">Bộ lọc</strong>
                                </h6>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label" for="movieFilter">Movie</label>
                                    <select class="form-control" id="movieFilter" name="movieFilter">

                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label" for="branchFilter">Branch</label>
                                    <select class="form-control" id="branchFilter" name="branchFilter">

                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label" for="roomFilter">Room</label>
                                    <select class="form-control" id="roomFilter" name="roomFilter">

                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label" for="showDateFilter">Show Date</label>
                                    <select class="form-control" id="showDateFilter" name="showDateFilter">

                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label" for="showTimeSlotFilter">Show Time Slot</label>
                                    <select class="form-control" id="showTimeSlotFilter" name="showTimeSlotFilter">

                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-5">
                                    <h4 style="font-size: 30px">
                                        <i class="icon-copy fa fa-glass" aria-hidden="true"></i>
                                        <strong> List Show Schedule</strong>
                                    </h4>
                                </div>
                            </div>

                            <!--                            <div class="row mt-1">-->

                            <!--                                <div class="col-sm-4 ">-->
                            <!--                                    <div id="DataTables_Table_0_filter" class="dataTables_filter">-->
                            <!--                                        <a style="box-shadow: 0 0 1px 1px #4a4b59;" class="btn btn-light create-modal float-end">-->
                            <!--                                            <i class="icon-copy fa fa-plus-square" aria-hidden="true"></i>-->
                            <!--                                            <span><strong> Add New Show Schedule</strong></span>-->
                            <!--                                        </a>-->
                            <!--                                    </div>-->
                            <!--                                </div>-->

                            <!--                                <div class="col-sm-4 header-search">-->
                            <!--                                    <form>-->
                            <!--                                        <div class="form-group mb-0">-->
                            <!--                                            <i id="search-icon" class="icon-copy fa fa-search" aria-hidden="true"></i>-->
                            <!--                                            <input id="search-input" type="text" class="form-control search-input" placeholder="Search Here">-->
                            <!--                                        </div>-->
                            <!--                                    </form>-->
                            <!--                                </div>-->
                            <!--                            </div>-->

                            <div id="tickets-table_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="dataTables_length" id="tickets-table_length"><label>Show <select
                                                name="tickets-table_length"
                                                aria-controls="tickets-table"
                                                class="custom-select custom-select-sm form-control form-control-sm">
                                            <option value="10">10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select> entries</label></div>
                                    </div>

                                    <div class="col-sm-4 ">
                                        <div id="DataTables_Table_0_filter" class="dataTables_filter">
                                            <a style="box-shadow: 0 0 1px 1px #4a4b59;"
                                               class="btn btn-light create-modal float-end">
                                                <i class="icon-copy fa fa-plus-square" aria-hidden="true"></i>
                                                <span><strong> Add New Show Schedule</strong></span>
                                            </a>
                                        </div>
                                    </div>

                                    <div class="col-sm-4 header-search">
                                        <form>
                                            <div class="form-group mb-0">
                                                <i id="search-icon" class="icon-copy fa fa-search"
                                                   aria-hidden="true"></i>
                                                <input id="search-input" type="text" class="form-control search-input"
                                                       placeholder="Search Here">
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-12">
                                        <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100"
                                               cellspacing="0" id="tickets-table">
                                            <thead class="bg-light">
                                            <tr>
                                                <th class="font-weight-medium">ID</th>
                                                <th class="font-weight-medium">Movie</th>
                                                <th class="font-weight-medium">Room</th>
                                                <th class="font-weight-medium">Branch</th>
                                                <th class="font-weight-medium">Show Time SLot</th>
                                                <th class="font-weight-medium">Show Date</th>
                                                <th class="font-weight-medium">Create By</th>
                                                <th class="font-weight-medium" style="width: 120px">Action</th>
                                            </tr>
                                            </thead>

                                            <tbody class="font-14">

                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-12 col-md-5">
                                        <div class="dataTables_info" id="tickets-table_info" role="status"
                                             aria-live="polite">
                                            Showing <span id="start"></span> to <span id="end">  </span> of <span
                                                id="numOfData"></span> entries
                                        </div>
                                    </div>
                                    <div class="col-sm-12 col-md-7">
                                        <div class="dataTables_paginate paging_simple_numbers"
                                             id="tickets-table_paginate">
                                            <ul class="pagination pagination-rounded">
                                                <!--                                                <li class="paginate_button page-item previous disabled" id="tickets-table_previous"><a href="#"-->
                                                <!--                                                                                                                                       aria-controls="tickets-table" data-dt-idx="0" tabindex="0" class="page-link"><i-->
                                                <!--                                                        class="mdi mdi-chevron-left"></i></a></li>-->
                                                <!--                                                <li class="paginate_button page-item active"><a href="#" aria-controls="tickets-table"-->
                                                <!--                                                                                                data-dt-idx="1" tabindex="0" class="page-link">1</a></li>-->
                                                <!--                                                <li class="paginate_button page-item "><a href="#" aria-controls="tickets-table" data-dt-idx="2"-->
                                                <!--                                                                                          tabindex="0" class="page-link">2</a></li>-->
                                                <!--                                                <li class="paginate_button page-item next" id="tickets-table_next"><a href="#"-->
                                                <!--                                                                                                                      aria-controls="tickets-table" data-dt-idx="3" tabindex="0" class="page-link"><i-->
                                                <!--                                                        class="mdi mdi-chevron-right"></i></a></li>-->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div><!-- end col -->
                </div>
                <!-- end row -->

            </div> <!-- container -->

        </div> <!-- content -->

        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-6">
                        2016 - 2019 &copy; Minton theme by <a href="">Coderthemes</a>
                    </div>
                    <div class="col-md-6">
                        <div class="text-md-right footer-links d-none d-sm-block">
                            <a href="javascript:void(0);">About Us</a>
                            <a href="javascript:void(0);">Help</a>
                            <a href="javascript:void(0);">Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->
</div>

<th:block th:replace="/show_schedule/modal_create_show_schedule :: modal_create_show_schedule"/>
<th:block th:replace="/show_schedule/modal_update_show_schedule :: modal_update_show_schedule"/>
<th:block th:replace="/show_schedule/temp_show_schedule :: temp_list_show_schedule"/>

<script src="/assets/js/app/custom-validation-schedule.js"></script>
<th:block th:replace="/layout/script :: script-app"/>
<th:block th:replace="/layout/script :: script-page"/>

<script src="/assets/js/app/jquery.validate.js"></script>
</body>
<script>

    let page = {
        url: {
            getDataLength: App.BASE_URL + "/show-schedules",
            getSchedulesPaging: App.BASE_URL + "/show-schedules/paging/",
            getScheduleById: App.BASE_URL + "/show-schedules/",
            createShowSchedule: App.BASE_URL + "/show-schedules/create",
            updateShowSchedule: App.BASE_URL + "/show-schedules/update/",
            deleteShowSchedule: App.BASE_URL + "/show-schedules/delete/",
            searchShowSchedule: App.BASE_URL + "/show-schedules/search",
            getAllBranch: App.BASE_URL + "/branches",
            getAllRoomByBranchId: App.BASE_URL + "/rooms/",
            getAllMovie: App.BASE_URL + "/movies",
            getAllBranchByMovieId: App.BASE_URL + "/branches/",
            getAllRoomByMovieAndBranch: App.BASE_URL + "/show-schedules/rooms/",
            getAllShowDateByMovieAndRoom: App.BASE_URL + "/show-schedules/show-date/",
            getAllShowTimeSlot: App.BASE_URL + "/show-schedules/show-time-slot/"
        },
        element: {},
        loadData: {},
        commands: {},
        dialogs: {
            element: {},
            commands: {}
        }
    }

    page.element.tbBody = $("#tickets-table tbody");
    page.element.searchIcon = $('#search-icon');
    page.element.searchInput = $("#search-input");
    page.element.tempShowSchedule = $("#tempShowSchedule");
    page.element.movieFilter = $("#movieFilter");
    page.element.branchFilter = $("#branchFilter");
    page.element.roomFilter = $("#roomFilter");
    page.element.showDateFilter = $("#showDateFilter");
    page.element.showTimeSlotFilter = $("#showTimeSlotFilter");
    page.element.ulPaging = $("#tickets-table_paginate ul");


    page.dialogs.element.handleCre = $(".create-modal");

    page.dialogs.element.mdCreate = $("#modalCreateShowSchedule");
    page.dialogs.element.mdUpdate = $("#modalUpdateShowSchedule");

    page.dialogs.element.btnCreate = $("#btnCreateShowSchedule")
    page.dialogs.element.btnUpdate = $("#btnUpdateShowSchedule");
    page.dialogs.element.btnClose = $(".btn-close");


    page.dialogs.element.frmCreate = $("#frmCreateShowSchedule");
    page.dialogs.element.frmUpdate = $("#frmUpdateShowSchedule");

    page.dialogs.element.movieId = $("#movie");
    page.dialogs.element.branchId = $("#branch");
    page.dialogs.element.roomId = $("#room");
    page.dialogs.element.showDate = $("#showDate");
    page.dialogs.element.showTimeSlot = $("#showTimeSlot");

    page.dialogs.element.movieIdUp = $("#movieUp");
    page.dialogs.element.branchIdUp = $("#branchUp");
    page.dialogs.element.roomIdUp = $("#roomUp");
    page.dialogs.element.showDateUp = $("#showDateUp");
    page.dialogs.element.showTimeSlotUp = $("#showTimeSlotUp");

    page.dialogs.element.mdAlertDangerCre = $("#modalCreateShowSchedule .modal-alert-danger");
    page.dialogs.element.mdAlertDangerUp = $("#modalUpdateShowSchedule .modal-alert-danger");

    page.dialogs.element.inputErrorCre = $("#frmCreateShowSchedule input.error");
    page.dialogs.element.inputErrorUp = $("#frmUpdateShowSchedule input.error");


    let showSchedule = new ShowSchedule();
    let pageSize = 5;
    let maxNavigationPage = 2;
    let dataLength = 0;


    let tempShowSchedule = $.validator.format($.trim(page.element.tempShowSchedule.val().toString()));

    page.commands.findById = (id) => {
        return $.ajax({
            type: "GET",
            url: page.url.getScheduleById + id
        })
            .done((data) => {
                showSchedule = data;
            })
            .fail((err) => {
                alert("Id not found");
            })
    }

    page.commands.addRow = () => {
        page.element.tbBody.prepend($(tempShowSchedule(showSchedule.id, showSchedule.movieName, showSchedule.roomName, showSchedule.branchName, showSchedule.showDate, showSchedule.showTimeSlot)));
    }

    page.commands.updateRow = () => {
        let currentRow = $("#tr_" + showSchedule.id);
        let rowUpdated = $(tempShowSchedule(showSchedule.id, showSchedule.movieName, showSchedule.roomName, showSchedule.branchName, showSchedule.showDate, showSchedule.showTimeSlot))

        currentRow.replaceWith(rowUpdated);
    }

    page.commands.deleteRow = (id) => {
        let currentRow = $("#tr_" + id);
        currentRow.replaceWith("");
    }

    page.dialogs.element.handleCre.on("click", function () {
        page.commands.loadShowScheduleInfo();
        page.dialogs.element.mdCreate.modal("show");
    })


    page.commands.handleUpdateBtn = () => {

        $(".update").on('click', function () {
            let id = $(this).data('id');
            page.commands.findById(id).then(function () {
                page.dialogs.element.movieIdUp.val(showSchedule.movieId);
                page.dialogs.element.showDateUp.val(showSchedule.showDate);
                page.dialogs.element.showTimeSlotUp.val(showSchedule.showTimeSlot);

                page.dialogs.element.branchIdUp.val(showSchedule.branchId);

                page.commands.getRoom(showSchedule.branchId).then(() => {
                    page.dialogs.element.roomIdUp.val(showSchedule.roomId);
                })

                page.dialogs.element.mdUpdate.modal('show');
            });
        });
    }

    page.commands.handleDeleteBtn = () => {
        $(".delete").on("click", function () {
            let id = $(this).data("id");

            page.commands.findById(id).then(function () {
                App.SweetAlert.showRemoveConfirmDialog()
                    .then((result) => {

                        if (result.isConfirmed)
                            doDelete();
                    });
            }).catch(() => {
                alert("handleBlock fail!");
            })
        })
    }


    page.commands.handleBtn = () => {
        page.commands.handleUpdateBtn();
        page.commands.handleDeleteBtn();
    }

    page.dialogs.element.btnCreate.on("click", function () {
        page.dialogs.element.mdAlertDangerCre.removeClass('show').addClass('hide').empty();
        page.dialogs.element.frmCreate.submit();
    })

    page.dialogs.element.btnUpdate.on('click', function () {
        page.dialogs.element.mdAlertDangerUp.removeClass('show').addClass('hide').empty();
        page.dialogs.element.frmUpdate.submit();
    })

    page.commands.getDataLength = () => {

        return $.ajax({
            type: "GET",
            url: page.url.getDataLength,
        }).done((data) => {
            console.log(data);
            dataLength = data;
        })
            .fail((err) => {
                alert("Get data length fail!");
            })
    }

    page.commands.getMovie = () => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllMovie,
        }).done((data) => {
            page.dialogs.element.movieId.empty();
            page.dialogs.element.movieIdUp.empty();
            page.element.movieFilter.empty();

            $.each(data, (i, item) => {
                let str = `<option value="${item.id}">${item.title}</option>`;
                page.dialogs.element.movieId.append(str);
                page.dialogs.element.movieIdUp.append(str)
                page.element.movieFilter.append(str);
            })
        })
            .fail((err) => {
                alert("Load movie fail!");
            })
    }

    page.commands.getBranch = () => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllBranch
        }).done((data) => {
            page.dialogs.element.branchId.empty();
            page.dialogs.element.branchIdUp.empty();


            $.each(data, (i, item) => {
                let str = `<option value="${item.id}">${item.name}</option>`;
                page.dialogs.element.branchId.append(str);
                page.dialogs.element.branchIdUp.append(str);

            })
        })
            .fail((err) => {
                alert("Load branch fail!");
            })
    }

    page.commands.getRoom = (branchId) => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllRoomByBranchId + branchId,
        })
            .done((data) => {
                page.dialogs.element.roomId.empty();
                page.dialogs.element.roomIdUp.empty();


                $.each(data, (i, item) => {
                    let str = `<option value="${item.id}">${item.name}</option>`;
                    page.dialogs.element.roomId.append(str);
                    page.dialogs.element.roomIdUp.append(str);
                })
            })
            .fail((err) => {
                alert("Load room failed!");
            })
    }

    page.commands.getAllBranchByMovie = (movieId) => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllBranchByMovieId + movieId,
        })
            .done((data) => {
            page.element.branchFilter.empty();

            $.each(data, (i, item) => {

                let str = `<option value="${item.id}">${item.name}</option>`;
                page.element.branchFilter.append(str);

            })
        })
            .fail((err) => {
                alert("Load branch fail!");
            })
    }

    page.commands.getAllRoomByMovieAndBranch = (movieId, branchId) => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllRoomByMovieAndBranch + movieId + "/" + branchId,
        }).done((data) => {
            page.element.roomFilter.empty();

            $.each(data, (i, item) => {

                let str = `<option value="${item.id}">${item.name}</option>`;
                page.element.roomFilter.append(str);

            })
        })
            .fail((err) => {
                alert("Load room fail!");
            })
    }

    page.commands.getAllShowDateByMovieAndRoom = (movieId, roomId) => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllShowDateByMovieAndRoom + movieId + "/" + roomId,
        }).done((data) => {
            page.element.showDateFilter.empty();

            $.each(data, (i, item) => {

                let str = `<option value="${item}">${item}</option>`;
                page.element.showDateFilter.append(str);

            })
        })
            .fail((err) => {
                alert("Load show date fail!");
            })
    }

    page.commands.getAllShowTimeSlotBy = (movieId, roomId, showDate) => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllShowTimeSlot + movieId + "/" + roomId + "/" + showDate,
        }).done((data) => {
            page.element.showTimeSlotFilter.empty();

            $.each(data, (i, item) => {

                let str = `<option value="${item}">${item}</option>`;
                page.element.showTimeSlotFilter.append(str);

            })
        })
            .fail((err) => {
                alert("Load show time slot fail!");
            })
    }

    page.commands.draw = (start, end) => {
        let numberOfPage = Math.ceil(dataLength / pageSize);
        let tabIndex = end / maxNavigationPage;

        end = (end > numberOfPage) ? numberOfPage : end;


        console.log(end);

        page.element.ulPaging.empty();


        page.element.ulPaging.append(`<li class="paginate_button page-item previous" id="tickets-table_previous">
                                            <a href="#" aria-controls="tickets-table"  tabindex="${tabIndex}" class="page-link">
                                                <i class="mdi mdi-chevron-left"></i>
                                            </a>
                                      </li>`);

        for (let i = start; i < end; i++) {
            let str = `<li class="paginate_button page-item">
                                <a href="#" aria-controls="tickets-table" data-dt-idx="${i + 1}" tabindex="${tabIndex}"
                                    class="page-link btn-paging">${i + 1}
                                </a>
                           </li>`;
            page.element.ulPaging.append(str);
        }

        // $(`.paginate_button a[ data-dt-idx = ${start + 1}] `).parent().addClass("active");


        page.element.ulPaging.append(`<li class="paginate_button page-item next" id="tickets-table_next">
                                           <a href="#" aria-controls="tickets-table"  tabindex="${tabIndex}" class="page-link">
                                               <i class="mdi mdi-chevron-right"></i>
                                           </a>
                                      </li>`);
    }

    $(document).on("click", "#tickets-table_next a", function (e) {
        e.preventDefault();
        let tabIndex = $(this).attr("tabindex");
        let start = tabIndex * maxNavigationPage;
        let end = (1 + Number(tabIndex)) * maxNavigationPage;
        let numberTabIndex = Math.ceil(Math.ceil(dataLength / pageSize) / maxNavigationPage);

        if (tabIndex == numberTabIndex) {
            $(this).parent().addClass("disabled");
        } else {
            page.commands.draw(start, end);
        }

    })

    $(document).on("click", "#tickets-table_previous a", function (e) {
        e.preventDefault();
        let tabIndex = $(this).attr("tabindex");
        let start = (tabIndex - 2) * maxNavigationPage;
        let end = (Number(tabIndex) - 1) * maxNavigationPage;

        if (tabIndex == 1) {
            $(this).parent().addClass("disabled");
        } else {
            page.commands.draw(start, end);

        }
    })

    $(document).on("click", ".btn-paging", function (e) {
        e.preventDefault();

        let dataIndex = $(this).attr("data-dt-idx");
        let startData = (Number(dataIndex) - 1) * pageSize + 1;
        let endData = dataIndex * pageSize;

        $(this).parent().parent().find(' > li').removeClass('active');
        $(this).parent().addClass('active');

        $("#start").text(startData);
        $("#end").text(endData);

        console.log(dataIndex);
        page.loadData.loadShowSchedule(dataIndex);
    })

    page.element.movieFilter.on("change", function () {
        let movieIdFilter = page.element.movieFilter.val();
        page.commands.getAllBranchByMovie(movieIdFilter).then(() => {
            let branchIdFilter = page.element.branchFilter.val();
            page.commands.getAllRoomByMovieAndBranch(movieIdFilter, branchIdFilter).then(() => {
                let roomIdFilter = page.element.roomFilter.val();
                page.commands.getAllShowDateByMovieAndRoom(movieIdFilter, roomIdFilter).then(() => {
                    let showDateFilter = page.element.showDateFilter.val();
                    page.commands.getAllShowTimeSlotBy(movieIdFilter, roomIdFilter, showDateFilter);
                })
            })
        })
    })

    page.element.branchFilter.on("change", function () {
        let movieIdFilter = page.element.movieFilter.val();
        let branchIdFilter = page.element.branchFilter.val();

        page.commands.getAllRoomByMovieAndBranch(movieIdFilter, branchIdFilter).then(() => {
            let roomIdFilter = page.element.roomFilter.val();
            page.commands.getAllShowDateByMovieAndRoom(movieIdFilter, roomIdFilter).then(() => {
                let showDateFilter = page.element.showDateFilter.val();
                page.commands.getAllShowTimeSlotBy(movieIdFilter, roomIdFilter, showDateFilter);
            })
        })
    })

    page.element.roomFilter.on("change", function () {
        let movieIdFilter = page.element.movieFilter.val();
        let roomIdFilter = page.element.roomFilter.val();

        page.commands.getAllShowDateByMovieAndRoom(movieIdFilter, roomIdFilter).then(() => {
            let showDateFilter = page.element.showDateFilter.val();
            page.commands.getAllShowTimeSlotBy(movieIdFilter, roomIdFilter, showDateFilter);
        })

    })

    page.element.showDateFilter.on("change", function () {
        let movieIdFilter = page.element.movieFilter.val();
        let roomIdFilter = page.element.roomFilter.val();
        let showDateFilter = page.element.showDateFilter.val();
        page.commands.getAllShowTimeSlotBy(movieIdFilter, roomIdFilter, showDateFilter);
    })

    page.dialogs.element.branchId.on("input", function () {
        let branchId = page.dialogs.element.branchId.val();
        page.commands.getRoom(branchId);
    })

    page.dialogs.element.branchIdUp.on("input", function () {
        let branchId = page.dialogs.element.branchIdUp.val();
        page.commands.getRoom(branchId);
    })

    page.commands.loadShowScheduleInfo = () => {
        page.commands.getMovie().then(() => {
            page.commands.getBranch().then(() => {
                let branchId = page.dialogs.element.branchId.val();
                page.commands.getRoom(branchId);
            })
        })
    }

    page.commands.loadShowScheduleFilter = () => {
        page.commands.getMovie().then(() => {
            let movieIdFilter = page.element.movieFilter.val();
            page.commands.getAllBranchByMovie(movieIdFilter).then(() => {
                let branchIdFilter = page.element.branchFilter.val();
                page.commands.getAllRoomByMovieAndBranch(movieIdFilter, branchIdFilter).then(() => {
                    let roomIdFilter = page.element.roomFilter.val();
                    page.commands.getAllShowDateByMovieAndRoom(movieIdFilter, roomIdFilter).then(() => {
                        let showDateFilter = page.element.showDateFilter.val();
                        page.commands.getAllShowTimeSlotBy(movieIdFilter, roomIdFilter, showDateFilter);
                    })
                })
            })
        })
    }


    page.loadData.loadShowSchedule = (dataIndex) => {
        $.ajax({
            type: "GET",
            url: page.url.getSchedulesPaging + (Number(dataIndex) - 1) + "/" + pageSize,
        })
            .done((item) => {
                page.element.tbBody.empty();

                $.each(item, (i, item) => {
                    showSchedule = item;
                    page.commands.addRow();

                    page.commands.handleBtn();


                })

            })
            .fail((jqXHR) => {
                let str = ``;

                if (jqXHR.status === 401) {
                    setTimeout(() => {
                        App.SweetAlert.showErrorAlert(App.ERROR_401);
                    }, 3000)

                    location.href = "/logout";

                } else if (jqXHR.status === 403) {
                    location.href = "/errors/403";

                } else if (jqXHR.status === 500) {
                    location.href = "/errors/500";
                } else if (jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}Read-error" class="error" for="${key}Read">${value}</label>`;
                        $("#" + key).addClass("error");
                    });
                    l
                }
            })
    }


    page.commands.doCreate = () => {

        delete showSchedule.id;
        showSchedule.movieId = page.dialogs.element.movieId.val();
        showSchedule.movieName = $("#movie option:selected").text();
        showSchedule.branchId = page.dialogs.element.branchId.val();
        showSchedule.branchName = $("#branch option:selected").text();
        showSchedule.roomId = page.dialogs.element.roomId.val();
        showSchedule.roomName = $("#room option:selected").text();
        showSchedule.showDate = page.dialogs.element.showDate.val();
        showSchedule.showTimeSlot = page.dialogs.element.showTimeSlot.val();


        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: page.url.createShowSchedule,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {
                showSchedule = item;

                page.commands.addRow();

                page.commands.handleBtn();

                page.dialogs.element.mdCreate.modal("hide");

                App.SweetAlert.showSuccessAlert(App.CREATE_SHOW_SCHEDULE_SUCCESS);
            })
            .fail((jqXHR) => {

                let str = ``;

                if (jqXHR.status === 401) {
                    setTimeout(() => {
                        App.SweetAlert.showErrorAlert(App.ERROR_401);
                    }, 3000)

                    location.href = "/logout";

                } else if (jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                } else if (jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                } else if (jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}-error" class="error" for="${key}">${value}</label>`;
                        $("#" + key).addClass("error");
                    });

                }

                page.dialogs.element.mdAlertDangerCre.empty().removeClass("hide").addClass("show").append(str);
            });
        page.dialogs.element.frmCreate[0].reset();
    }

    page.commands.doUpdate = () => {

        showSchedule.movieId = page.dialogs.element.movieIdUp.val();
        showSchedule.movieName = $("#movieUp option:selected").text();
        showSchedule.branchId = page.dialogs.element.branchIdUp.val();
        showSchedule.branchName = $("#branchUp option:selected").text();
        showSchedule.roomId = page.dialogs.element.roomIdUp.val();
        showSchedule.roomName = $("#roomUp option:selected").text();
        showSchedule.showDate = page.dialogs.element.showDateUp.val()
        showSchedule.showTimeSlot = page.dialogs.element.showTimeSlotUp.val();


        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: page.url.updateShowSchedule + showSchedule.id,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {
                showSchedule = item;

                page.commands.updateRow();
                page.commands.handleBtn();
                page.dialogs.element.mdUpdate.modal("hide");

                App.SweetAlert.showSuccessAlert(App.UPDATE_SHOW_SCHEDULE_SUCCESS);

                dataLength++;

                $("#numOfData").text(dataLength);

            })
            .fail((jqXHR) => {

                let str = ``;

                if (jqXHR.status === 401) {
                    App.SweetAlert.showErrorAlert(App.ERROR_401);
                    setTimeout(() => {
                        location.href = "/logout";
                    }, 3000)

                } else if (jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                } else if (jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                } else if (jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}Up-error" class="error" for="${key}Up">${value}</label>`;
                        $("#" + key).addClass("error");
                    });
                    page.dialogs.element.mdAlertDangerUp.empty().removeClass("hide").addClass("show").append(str);
                }
            })
    }

    function doDelete() {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: page.url.deleteShowSchedule + showSchedule.id,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {

                page.commands.deleteRow(item);
                page.commands.handleBtn();

                App.SweetAlert.showSuccessAlert(App.DELETE_SHOW_SCHEDULE_SUCCESS);

                dataLength--;
                $("#numOfData").text(dataLength);
            })
            .fail((jqXHR) => {

                if (jqXHR.status === 401) {
                    App.SweetAlert.showErrorAlert(App.ERROR_401);
                    setTimeout(() => {
                        location.href = "/logout";
                    }, 3000)

                } else if (jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                } else if (jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                }
            })
    }


    page.dialogs.element.mdCreate.on("hidden.bs.modal", function () {
        page.dialogs.element.mdAlertDangerCre.empty().removeClass('show').addClass('hide');
        page.dialogs.element.frmCreate[0].reset();
    });

    page.dialogs.element.mdUpdate.on("hidden.bs.modal", function () {
        page.dialogs.element.mdAlertDangerUp.empty().removeClass('show').addClass('hide');
        page.dialogs.element.frmUpdate[0].reset();
    });


    page.commands.getToDay = (day) => {
        let today = new Date();
        let dd = String(today.getDate() + day).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    }

    page.dialogs.element.showDate.attr("min", page.commands.getToDay(0));

    page.dialogs.element.showDate.attr("max", function () {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = Number(today.getFullYear() + 1);
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    });

    page.dialogs.element.showDateUp.attr("min", page.commands.getToDay(0));

    page.dialogs.element.showDateUp.attr("max", function () {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = Number(today.getFullYear() + 1);
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    });

    page.dialogs.element.btnClose.on('click', () => {
        page.dialogs.element.mdCreate.modal('hide');
        page.dialogs.element.mdUpdate.modal('hide');
    });

    page.element.searchIcon.on('click', () => {
        let searchInput = page.element.searchInput.val();

        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "POST",
            "url": page.url.searchShowSchedule,
            "data": JSON.stringify(searchInput)
        })
            .done((item) => {
                page.element.tbBody.html("");

                $.each(item, (i, data) => {
                    showSchedule = data;
                    page.commands.addRow();
                })
                page.commands.handleBtn();
            })
            .fail ((err) => {
                alert("Search fail");
            })
    })

    $(document).on('keydown', function(e) {
        if(e.keyCode === 13) {
            e.preventDefault();
            let searchInput = page.element.searchInput.val();

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.searchShowSchedule,
                "data": JSON.stringify(searchInput)
            })
                .done((item) => {
                    page.element.tbBody.html("");

                    $.each(item, (i, data) => {
                        showSchedule = data;
                        page.commands.addRow();
                    })
                    page.commands.handleBtn();
                })
                .fail ((err) => {
                    alert("Search fail");
                })
        }
    });


    page.commands.getDataLength().then(() => {
        page.loadData.loadShowSchedule(1);
        page.commands.draw(0, maxNavigationPage);
        $(`.paginate_button a[ data-dt-idx = '1'] `).parent().addClass("active");
        $("#start").text("1");
        $("#end").text(pageSize);
        $("#numOfData").text(dataLength);
    })

    page.commands.loadShowScheduleInfo();
    page.commands.loadShowScheduleFilter();


</script>
</html>